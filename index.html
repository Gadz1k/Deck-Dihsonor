<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deck & Dishonor - Prototyp (WebSocket)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-y: scroll;
        }
        .card {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .card:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .player-turn {
            box-shadow: 0 0 15px 5px rgba(250, 204, 21, 0.7); /* Żółta poświata */
            border-color: #FBBF24;
        }
        #game-log {
            height: 150px;
            font-size: 0.875rem;
        }
        #game-log::-webkit-scrollbar { width: 8px; }
        #game-log::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #game-log::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #game-log::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-7xl mx-auto">

        <div id="login-section" class="text-center bg-gray-800 p-8 rounded-xl shadow-2xl max-w-md mx-auto">
            <h1 class="text-4xl font-bold mb-2 text-yellow-400">Deck & Dishonor</h1>
            <p class="text-gray-400 mb-6">Wprowadź ID gry, aby dołączyć, lub utwórz nową.</p>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" id="game-id-input" placeholder="Wpisz ID Gry" class="flex-grow bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                <button id="create-game-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">Utwórz Grę</button>
                <button id="join-game-btn" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg transition duration-300">Dołącz</button>
            </div>
            <p class="text-xs text-gray-500 mt-4">Twoje ID: <span id="user-id-display" class="font-mono">Łączenie...</span></p>
        </div>

        <div id="game-section" class="hidden">
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-yellow-400">Deck & Dishonor</h1>
                    <p class="text-sm text-gray-400">ID Gry: <span id="game-id-display" class="font-mono bg-gray-700 px-2 py-1 rounded"></span></p>
                </div>
                <div class="text-center">
                    <p class="text-lg">Runda: <span id="round-counter" class="font-bold text-xl">1</span>/10</p>
                    <p id="turn-info" class="text-yellow-300 font-semibold"></p>
                </div>
                <button id="start-game-btn" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Rozpocznij Grę</button>
            </div>

            <div id="players-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4"></div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                <div class="lg:col-span-2 bg-gray-800 p-4 rounded-xl shadow-lg">
                    <h3 class="font-bold text-lg mb-2 border-b border-gray-700 pb-2">Log Gry</h3>
                    <div id="game-log" class="overflow-y-auto pr-2 text-gray-300 space-y-1"></div>
                </div>
                <div id="draft-area" class="bg-gray-800 p-4 rounded-xl shadow-lg flex flex-col items-center justify-center min-h-[150px]">
                     <h3 class="font-bold text-lg mb-2">Wybierz kartę</h3>
                     <div id="draft-cards" class="flex flex-wrap justify-center gap-2"></div>
                </div>
            </div>

            <div class="fixed bottom-0 left-0 right-0 bg-gray-900/80 backdrop-blur-sm p-4 border-t-2 border-yellow-500">
                <h2 class="text-center text-xl font-bold mb-3">Twoja Ręka</h2>
                <div id="player-hand" class="flex justify-center items-end gap-2 h-48"></div>
            </div>
        </div>
        
        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div id="modal-content" class="bg-gray-800 rounded-xl shadow-2xl p-8 max-w-lg w-full text-center">
                <h3 id="modal-title" class="text-2xl font-bold mb-4"></h3>
                <p id="modal-message" class="mb-6"></p>
                <div id="modal-options" class="flex flex-wrap justify-center gap-4"></div>
                <button id="modal-close-btn" class="mt-6 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Zamknij</button>
            </div>
        </div>
    </div>

    <script>
        // --- ZMIENNE GLOBALNE I KONFIGURACJA ---
        let clientId;
        let gameId;
        
        // WAŻNE: ZMIEŃ 'localhost' NA ADRES IP HOSTA, ABY GRAĆ PRZEZ SIEĆ LOKALNĄ
        const ws = new WebSocket('ws://localhost:8080');

        const loginSection = document.getElementById('login-section');
        const gameSection = document.getElementById('game-section');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const gameIdInput = document.getElementById('game-id-input');
        const userIdDisplay = document.getElementById('user-id-display');
        const gameIdDisplay = document.getElementById('game-id-display');
        const roundCounter = document.getElementById('round-counter');
        const turnInfo = document.getElementById('turn-info');
        const startGameBtn = document.getElementById('start-game-btn');
        const playersContainer = document.getElementById('players-container');
        const gameLog = document.getElementById('game-log');
        const draftArea = document.getElementById('draft-area');
        const draftCardsContainer = document.getElementById('draft-cards');
        const playerHand = document.getElementById('player-hand');
        
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOptions = document.getElementById('modal-options');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // --- DEFINICJE KART (potrzebne do renderowania) ---
        const CARDS = [
            { id: 'atk1', name: 'Soczysty Mem', type: 'Atak', description: 'Cel traci 3 Honoru.', needsTarget: true },
            { id: 'atk2', name: 'Teoria Spiskowa', type: 'Atak', description: 'Cel traci 2 Honoru i dostaje 1 kartę Skandalu.', needsTarget: true },
            { id: 'atk3', name: 'Publiczne Pranie Brudów', type: 'Atak', description: 'Wszyscy pozostali gracze tracą 2 Honoru.', needsTarget: false },
            { id: 'def1', name: 'To Fake News!', type: 'Obrona', description: 'Zablokuj następny Atak skierowany w Ciebie.', needsTarget: false },
            { id: 'def2', name: 'Tarcza Ignorancji', type: 'Obrona', description: 'Zablokuj następny Sabotaż.', needsTarget: false },
            { id: 'sab1', name: 'Zmień Temat!', type: 'Sabotaż', description: 'Przekieruj następny Atak na innego gracza.', needsTarget: true },
            { id: 'sab2', name: 'Kryzys Wizerunkowy', type: 'Sabotaż', description: 'Wybrany gracz pomija swoją następną turę.', needsTarget: true },
            { id: 'sab3', name: 'Kradzież Tożsamości', type: 'Sabotaż', description: 'Ukradnij losową kartę z ręki wybranego gracza.', needsTarget: true },
            { id: 'bst1', name: 'Wiralowy Taniec', type: 'Boost', description: 'Zyskujesz 3 Honoru.', needsTarget: false },
            { id: 'bst2', name: 'Kawa i Nadgodziny', type: 'Boost', description: 'Dobierz 1 kartę i wykonaj dodatkową akcję w tej turze.', needsTarget: false },
            { id: 'bst3', name: 'Apel o Wsparciu', type: 'Boost', description: 'Każdy inny gracz musi oddać Ci 1 Honoru (jeśli ma).', needsTarget: false },
        ];
        
        // --- OBSŁUGA WEBSOCKET ---
        ws.onopen = () => {
            console.log('Połączono z serwerem WebSocket.');
        };

        ws.onmessage = event => {
            const data = JSON.parse(event.data);
            switch (data.type) {
                case 'welcome':
                    clientId = data.clientId;
                    userIdDisplay.textContent = clientId;
                    break;
                case 'update':
                    renderGame(data.gameData);
                    break;
                case 'error':
                    alert('Błąd serwera: ' + data.message);
                    break;
            }
        };

        ws.onerror = error => {
            console.error('Błąd WebSocket:', error);
            alert('Utracono połączenie z serwerem. Odśwież stronę, aby spróbować ponownie.');
        };

        function sendMessage(type, payload = {}) {
            ws.send(JSON.stringify({ type, gameId, payload }));
        }
        
        // --- RENDEROWANIE INTERFEJSU ---
        function renderGame(gameData) {
            gameId = gameData.gameId;
            loginSection.classList.add('hidden');
            gameSection.classList.remove('hidden');
            
            const me = gameData.players.find(p => p.id === clientId);
            if (!me) return;

            gameIdDisplay.textContent = gameData.gameId;
            roundCounter.textContent = `${gameData.round}/10`;
            const currentPlayer = gameData.players.find(p => p.id === gameData.currentTurnPlayerId);
            turnInfo.textContent = currentPlayer ? `Tura gracza: ${currentPlayer.id === clientId ? 'Twoja' : currentPlayer.id}` : "Oczekiwanie na start...";

            gameLog.innerHTML = gameData.log.map(entry => `<div>${entry}</div>`).join('');
            gameLog.scrollTop = gameLog.scrollHeight;

            playersContainer.innerHTML = '';
            gameData.players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = `bg-gray-800 p-4 rounded-lg border-2 border-gray-700 transition-all duration-300 ${player.id === gameData.currentTurnPlayerId ? 'player-turn' : ''} ${player.isEliminated ? 'opacity-50' : ''}`;
                playerDiv.innerHTML = `
                    <h4 class="font-bold text-lg truncate ${player.id === clientId ? 'text-yellow-400' : ''}">${player.id} ${player.isHost ? '(Host)' : ''} ${player.id === clientId ? '(Ty)' : ''}</h4>
                    <p>Honor: <span class="font-bold text-2xl text-green-400">${player.honor}</span></p>
                    <p>Skandale: <span class="font-bold text-2xl text-red-400">${player.scandals}</span></p>
                    <p>Karty: <span class="font-bold">${player.hand.length}</span></p>
                    ${player.isEliminated ? '<p class="text-red-500 font-bold mt-2">WYELIMINOWANY</p>' : ''}
                `;
                playersContainer.appendChild(playerDiv);
            });

            playerHand.innerHTML = '';
            me.hand.forEach(cardData => {
                playerHand.appendChild(createCardElement(cardData, 'hand', gameData));
            });
            
            draftArea.classList.add('hidden');
            if (gameData.gameState === 'DRAFTING' && gameData.currentTurnPlayerId === clientId) {
                draftArea.classList.remove('hidden');
                draftCardsContainer.innerHTML = '';
                gameData.draftOptions.forEach(cardData => {
                    draftCardsContainer.appendChild(createCardElement(cardData, 'draft'));
                });
            }

            startGameBtn.classList.add('hidden');
            if (me.isHost && gameData.gameState === 'WAITING_FOR_PLAYERS' && gameData.players.length >= 2) {
                startGameBtn.classList.remove('hidden');
            }

            if (gameData.gameState === 'GAME_OVER') {
                 showModal("Koniec Gry!", gameData.log[gameData.log.length - 1]);
            }
        }
        
        function createCardElement(cardData, context, gameData) {
            const card = CARDS.find(c => c.id === cardData.id);
            if (!card) return document.createElement('div');
            
            const cardDiv = document.createElement('div');
            let bgColor = 'bg-gray-700';
            if (card.type === 'Atak') bgColor = 'bg-red-800';
            if (card.type === 'Obrona') bgColor = 'bg-blue-800';
            if (card.type === 'Sabotaż') bgColor = 'bg-purple-800';
            if (card.type === 'Boost') bgColor = 'bg-green-800';

            cardDiv.className = `card w-40 h-auto p-3 rounded-lg flex flex-col justify-between cursor-pointer border-2 border-gray-600 hover:border-yellow-400 ${bgColor}`;
            cardDiv.innerHTML = `
                <div>
                    <h5 class="font-bold text-sm">${card.name}</h5>
                    <p class="text-xs text-yellow-300 font-semibold">${card.type}</p>
                </div>
                <p class="text-xs mt-2">${card.description}</p>
            `;
            
            if (context === 'draft') {
                cardDiv.onclick = () => sendMessage('draftCard', { cardId: card.id });
            }
            if (context === 'hand' && gameData.gameState === 'ACTION' && gameData.currentTurnPlayerId === clientId) {
                cardDiv.onclick = () => handlePlayCard(card.id, gameData);
            }
            
            return cardDiv;
        }

        function showModal(title, message, options = []) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalOptions.innerHTML = '';
            
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg';
                btn.textContent = opt.label;
                btn.onclick = () => {
                    opt.callback();
                    modal.classList.add('hidden');
                };
                modalOptions.appendChild(btn);
            });
            
            modal.classList.remove('hidden');
        }
        
        modalCloseBtn.onclick = () => modal.classList.add('hidden');

        // --- AKCJE GRACZA (wysyłają wiadomości do serwera) ---
        function handlePlayCard(cardId, gameData) {
            const card = CARDS.find(c => c.id === cardId);
            if (card.needsTarget) {
                const targets = gameData.players.filter(p => p.id !== clientId && !p.isEliminated);
                if (targets.length === 0) {
                    showModal("Brak celu", "Nie ma dostępnych graczy, by ich obrać za cel.");
                    return;
                }
                const options = targets.map(target => ({
                    label: target.id,
                    callback: () => sendMessage('playCard', { cardId: cardId, targetId: target.id })
                }));
                showModal("Wybierz cel", `Kogo chcesz obrać za cel dla "${card.name}"?`, options);
            } else {
                sendMessage('playCard', { cardId: cardId });
            }
        }

        createGameBtn.addEventListener('click', () => {
            gameId = gameIdInput.value.trim();
            if (gameId) {
                sendMessage('createGame');
            } else {
                alert('Wpisz ID gry.');
            }
        });

        joinGameBtn.addEventListener('click', () => {
            gameId = gameIdInput.value.trim();
            if (gameId) {
                sendMessage('joinGame');
            } else {
                alert('Wpisz ID gry.');
            }
        });
        
        startGameBtn.addEventListener('click', () => sendMessage('startGame'));

    </script>
</body>
</html>
